<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analytics Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#020617;
      --panel:#020617;
      --border:rgba(55,65,81,0.9);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --link:#60a5fa;
      --ok:#4ade80;
      --warn:#facc15;
      --bad:#fca5a5;
    }
    html, body { background: var(--bg); color: var(--text); }
    body { padding: 16px; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    a { color: var(--link); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .container { max-width: 1250px; margin: 0 auto; }
    h1 { font-size: 1.5rem; margin: 6px 0 4px; }
    .sub { color: var(--muted); font-size: 0.9rem; margin: 0 0 14px; }

    .grid12 { display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .span-12 { grid-column: span 12; }
    .span-8 { grid-column: span 8; }
    .span-6 { grid-column: span 6; }
    .span-4 { grid-column: span 4; }
    .span-3 { grid-column: span 3; }

    @media (max-width: 1024px){
      .span-8,.span-6,.span-4,.span-3 { grid-column: span 12; }
    }

    .kicker { font-size: 0.85rem; color: var(--muted); margin-bottom: 6px; }
    .big { font-size: 1.6rem; font-weight: 700; }
    .row { display:flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 6px; }
    .pill {
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 10px; border-radius: 999px;
      font-size: 0.82rem; border:1px solid transparent;
    }
    .pill-ok { background: rgba(22,163,74,0.15); color: var(--ok); border-color: rgba(34,197,94,0.6); }
    .pill-warn { background: rgba(234,179,8,0.10); color: var(--warn); border-color: rgba(234,179,8,0.6); }
    .pill-bad { background: rgba(248,113,113,0.12); color: var(--bad); border-color: rgba(248,113,113,0.8); }

    .card h2 { font-size: 1.05rem; margin: 0 0 10px; }
    .note { color: var(--muted); font-size: 0.82rem; margin-top: 8px; }

    .chart-wrap { height: 260px; }
    canvas { width: 100% !important; height: 100% !important; }

    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 10px; }
    select {
      background: #0b1220;
      color: var(--text);
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.92rem;
      outline: none;
    }

    .split { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 1024px){ .split { grid-template-columns: 1fr; } }

    table { width:100%; border-collapse: collapse; font-size: 0.88rem; }
    th, td { padding: 8px 10px; border-bottom: 1px solid rgba(148,163,184,0.25); text-align:left; }
    th { position: sticky; top: 0; background: #020617; z-index: 1; }
    .table-wrap { max-height: 260px; overflow:auto; border-radius: 10px; border: 1px solid rgba(148,163,184,0.18); }

    .status-ok { color: var(--ok); font-weight: 700; }
    .status-nodev { color: #f97316; font-weight: 700; }
    .status-nobeac { color: var(--warn); font-weight: 700; }
    .status-nodata { color: #94a3b8; font-weight: 700; }
  </style>
</head>
<body>
  <div class="container">
    <a href="{{ url_for('map.map_page') }}">← Back to map</a>
    <h1>Analytics dashboard</h1>
    <p class="sub">Last {{ window_hours }} hours (uptime snapshots + IN/LEFT activity events).</p>

    <!-- Summary row -->
    <div class="grid12" style="margin-bottom:14px;">
      <div class="card span-4">
        <div class="kicker">Latest system snapshot</div>
        {% if latest_timestamp %}
          <div class="big">{{ latest_devices }} devices · {{ latest_beacons }} beacons</div>
          <div class="note">at {{ latest_timestamp }}</div>
          <div class="row">
            {% if latest_status == 'OK' %}
              <span class="pill pill-ok">OK</span>
            {% elif latest_status == 'NO_DEVICES' %}
              <span class="pill pill-warn">No devices</span>
            {% elif latest_status == 'NO_BEACONS' %}
              <span class="pill pill-warn">No beacons</span>
            {% elif latest_status == 'NO_DATA' %}
              <span class="pill pill-bad">No data</span>
            {% else %}
              <span class="pill pill-warn">{{ latest_status }}</span>
            {% endif %}
          </div>
        {% else %}
          <div class="big">No snapshots</div>
          <div class="note">Waiting for /flespi data…</div>
        {% endif %}
      </div>

      <div class="card span-4">
        <div class="kicker">Notifications in window</div>
        <div class="big">{{ total_events }}</div>
        <div class="note">IN / LEFT events recorded in the last {{ window_hours }} hours.</div>
      </div>

      <div class="card span-4">
        <div class="kicker">Uptime OK rate</div>
        <div class="big">{{ uptime_ok_percent }}%</div>
        <div class="note">How often the system status was <span class="status-ok">OK</span> in this window.</div>
        {% if most_active_beacon %}
          <div class="note" style="margin-top:10px;">Most active beacon: <strong>{{ most_active_beacon }}</strong></div>
        {% endif %}
      </div>
    </div>

    <!-- Charts row -->
    <div class="grid12" style="margin-bottom:14px;">
      <div class="card span-4">
        <h2>Devices & beacons over time</h2>
        <div class="chart-wrap"><canvas id="uptimeChart"></canvas></div>
        <div class="note">From uptime snapshots (gaps can mean downtime or no data).</div>
      </div>

      <div class="card span-4">
        <h2>Events per hour</h2>
        <div class="chart-wrap"><canvas id="hourlyChart"></canvas></div>
        <div class="note">When IN/LEFT notifications happen most.</div>
      </div>

      <div class="card span-4">
        <h2>Top beacons by activity</h2>
        <div class="chart-wrap"><canvas id="beaconChart"></canvas></div>
        <div class="note">Total IN/LEFT events per beacon.</div>
      </div>
    </div>

    <!-- Presence + Tables -->
    <div class="grid12">
      <div class="card span-6">
        <h2>Beacon presence</h2>
        {% if presence_summary %}
          <div class="controls">
            <span class="kicker" style="margin:0;">Beacon:</span>
            <select id="beaconSelect"></select>
          </div>

          <div class="split">
            <div>
              <div class="chart-wrap" style="height:240px;"><canvas id="presenceChart"></canvas></div>
              <div class="note" id="presenceNote"></div>
            </div>

            <div>
              <div class="kicker">Selected beacon summary</div>
              <div id="presenceSummary" class="note"></div>
              <div class="note" style="margin-top:10px;">
                Tip: Presence is computed from <strong>IN</strong> and <strong>LEFT</strong> events inside the window.
              </div>
            </div>
          </div>
        {% else %}
          <div class="note">No IN/LEFT events recorded in this window — presence % can’t be calculated yet.</div>
        {% endif %}
      </div>

      <div class="card span-6">
        <h2>Status breakdown</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Status</th>
                <th>Count</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
              {% for row in status_breakdown %}
                <tr>
                  <td>
                    {% if row.status == 'OK' %}
                      <span class="status-ok">OK</span>
                    {% elif row.status == 'NO_DEVICES' %}
                      <span class="status-nodev">No devices</span>
                    {% elif row.status == 'NO_BEACONS' %}
                      <span class="status-nobeac">No beacons</span>
                    {% elif row.status == 'NO_DATA' %}
                      <span class="status-nodata">No data</span>
                    {% else %}
                      {{ row.status }}
                    {% endif %}
                  </td>
                  <td>{{ row.count }}</td>
                  <td>{{ row.percent }}%</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if presence_summary %}
          <h2 style="margin-top:16px;">Presence table</h2>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Beacon</th>
                  <th>In %</th>
                  <th>Out %</th>
                  <th>In (hrs)</th>
                  <th>Out (hrs)</th>
                  <th>Events</th>
                </tr>
              </thead>
              <tbody>
                {% for p in presence_summary %}
                  <tr>
                    <td>{{ p.name }}</td>
                    <td>{{ p.in_percent }}%</td>
                    <td>{{ p.out_percent }}%</td>
                    <td>{{ p.in_hours }}</td>
                    <td>{{ p.out_hours }}</td>
                    <td>{{ p.event_count }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    // ---- Data from backend ----
    const uptimeLabels = {{ uptime_labels|tojson }};
    const deviceCounts = {{ device_counts|tojson }};
    const beaconCounts = {{ beacon_counts|tojson }};

    const hourlyLabels = {{ hourly_labels|tojson }};
    const hourlyCounts = {{ hourly_counts|tojson }};

    const beaconLabels = {{ beacon_labels|tojson }};
    const beaconTotals = {{ beacon_totals|tojson }};
    const beaconIns = {{ beacon_ins|tojson }};
    const beaconLefts = {{ beacon_lefts|tojson }};

    const presenceByBeacon = {{ presence_by_beacon_json|safe }};
    const defaultBeacon = {{ selected_beacon|tojson }};

    let presenceChart = null;

    function makeLineChart(ctx, labels, a, b) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Devices', data: a, tension: 0.2, fill: false },
            { label: 'Beacons', data: b, tension: 0.2, fill: false }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' } },
          scales: { x: { ticks: { maxTicksLimit: 8 } } }
        }
      });
    }

    function makeBarChart(ctx, labels, data, label) {
      return new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label, data, borderWidth: 1 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { ticks: { maxTicksLimit: 10 } } }
        }
      });
    }

    function makeStackedBeaconChart(ctx) {
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: beaconLabels,
          datasets: [
            { label: 'IN', data: beaconIns, borderWidth: 1 },
            { label: 'LEFT', data: beaconLefts, borderWidth: 1 },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' } },
          scales: {
            x: { stacked: true, ticks: { maxTicksLimit: 8 } },
            y: { stacked: true }
          }
        }
      });
    }

    function ensurePresenceChart() {
      const ctx = document.getElementById('presenceChart');
      if (!ctx) return null;
      if (presenceChart) return presenceChart;

      presenceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['In range', 'Out of range'],
          datasets: [{ data: [0, 0], borderWidth: 1 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          cutout: '60%'
        }
      });
      return presenceChart;
    }

    function formatHours(sec) {
      if (sec === null || sec === undefined) return '-';
      return (sec / 3600).toFixed(1);
    }

    function updatePresenceUI(beaconName) {
      const card = presenceByBeacon[beaconName];
      const note = document.getElementById('presenceNote');
      const summary = document.getElementById('presenceSummary');

      if (!card) {
        note.textContent = 'No presence data for this beacon in the current window.';
        summary.textContent = '';
        const ch = ensurePresenceChart();
        if (ch) {
          ch.data.datasets[0].data = [0, 0];
          ch.update();
        }
        return;
      }

      const ch = ensurePresenceChart();
      if (ch) {
        ch.data.datasets[0].data = [card.in_percent, card.out_percent];
        ch.update();
      }

      note.textContent = `In: ${card.in_percent}% · Out: ${card.out_percent}% (last ${card.event_count} events)`;

      const lastState = card.last_state ? card.last_state.toUpperCase() : 'N/A';
      const lastTime = card.last_event_time || 'N/A';
      summary.innerHTML = `
        <div><strong>${beaconName}</strong></div>
        <div style="margin-top:6px;">In time: <strong>${card.in_hours}</strong> hrs · Out time: <strong>${card.out_hours}</strong> hrs</div>
        <div style="margin-top:6px;">Last state: <strong>${lastState}</strong> at <strong>${lastTime}</strong></div>
      `;
    }

    function initPresenceDropdown() {
      const sel = document.getElementById('beaconSelect');
      if (!sel) return;

      const names = Object.keys(presenceByBeacon).sort((a,b)=>a.localeCompare(b));
      sel.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join('');

      const startName = (defaultBeacon && presenceByBeacon[defaultBeacon]) ? defaultBeacon : (names[0] || '');
      if (startName) {
        sel.value = startName;
        updatePresenceUI(startName);
      }

      sel.addEventListener('change', () => updatePresenceUI(sel.value));
    }

    window.addEventListener('load', () => {
      const uptimeCtx = document.getElementById('uptimeChart');
      if (uptimeCtx && uptimeLabels.length) makeLineChart(uptimeCtx, uptimeLabels, deviceCounts, beaconCounts);

      const hourlyCtx = document.getElementById('hourlyChart');
      if (hourlyCtx && hourlyLabels.length) makeBarChart(hourlyCtx, hourlyLabels, hourlyCounts, 'Events');

      const beaconCtx = document.getElementById('beaconChart');
      if (beaconCtx && beaconLabels.length) makeStackedBeaconChart(beaconCtx);

      initPresenceDropdown();
    });
  </script>
</body>
</html>
