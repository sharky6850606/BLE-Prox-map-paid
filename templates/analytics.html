<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Analytics Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <style>
    body { background:#020617; color:#e5e7eb; padding:16px; font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    a { color:#60a5fa; text-decoration:none; }
    a:hover { text-decoration:underline; }
    h1 { font-size:1.5rem; margin-bottom:8px; }
    h2 { font-size:1.1rem; margin:16px 0 8px; }
    .back-link { margin-bottom:12px; display:inline-block; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-bottom:16px; }
    .card { background:#020617; border-radius:8px; border:1px solid rgba(55,65,81,0.9); padding:12px 14px; }
    .card-title { font-size:0.95rem; font-weight:600; margin-bottom:4px; }
    .card-value { font-size:1.3rem; font-weight:600; }
    .pill { display:inline-block; padding:3px 10px; border-radius:999px; font-size:0.8rem; }
    .pill-ok { background:rgba(22,163,74,0.15); color:#4ade80; border:1px solid rgba(34,197,94,0.6); }
    .pill-warn { background:rgba(234,179,8,0.1); color:#facc15; border:1px solid rgba(234,179,8,0.6); }
    .pill-bad { background:rgba(248,113,113,0.12); color:#fca5a5; border:1px solid rgba(248,113,113,0.8); }
    .charts-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; margin-top:8px; }
    .chart-card { background:#020617; border-radius:8px; border:1px solid rgba(55,65,81,0.9); padding:12px 14px; }
    table { width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:8px; }
    th, td { padding:6px 8px; border-bottom:1px solid rgba(148,163,184,0.3); text-align:left; }
    th { background:#020617; position:sticky; top:0; }
    .status-ok { color:#4ade80; font-weight:600; }
    .status-nodev { color:#f97316; font-weight:600; }
    .status-nobeac { color:#eab308; font-weight:600; }
    .status-nodata { color:#94a3b8; font-weight:600; }
    .small-note { font-size:0.8rem; color:#9ca3af; margin-top:4px; }
  </style>
</head>
<body>
  <a href="{{ url_for('map.map_page') }}" class="back-link">← Back to map</a>
  <h1>Analytics dashboard</h1>
  <p class="small-note">Showing the last {{ window_hours }} hours of uptime and beacon activity.</p>

  <div class="grid">
    <div class="card">
      <div class="card-title">Latest system snapshot</div>
      {% if latest_timestamp %}
      <div class="card-value">{{ latest_devices }} devices · {{ latest_beacons }} beacons</div>
      <div class="small-note">at {{ latest_timestamp }}</div>
      <div style="margin-top:6px;">
        {% set s = latest_status or 'NO_DATA' %}
        {% if s == 'OK' %}
        <span class="pill pill-ok">OK</span>
        {% elif s == 'NO_DEVICES' %}
        <span class="pill pill-bad">No devices</span>
        {% elif s == 'NO_BEACONS' %}
        <span class="pill pill-warn">No beacons</span>
        {% else %}
        <span class="pill pill-bad">{{ s }}</span>
        {% endif %}
      </div>
      {% else %}
      <p class="small-note">No uptime data recorded yet.</p>
      {% endif %}
    </div>

    <div class="card">
      <div class="card-title">Notifications in window</div>
      <div class="card-value">{{ total_events }}</div>
      <div class="small-note">IN / LEFT events seen in the last {{ window_hours }} hours.</div>
    </div>

    <div class="card">
      <div class="card-title">Top active beacons</div>
      {% if beacon_labels %}
      <ul style="list-style:none; padding-left:0; margin:0;">
        {% for name in beacon_labels %}
        <li>{{ name }} – {{ beacon_totals[loop.index0] }} events</li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="small-note">No beacon activity recorded in this window.</p>
      {% endif %}
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <h2>Devices &amp; beacons over time</h2>
      <canvas id="uptimeChart"></canvas>
      <p class="small-note">Based on uptime snapshots. Gaps may indicate downtime, sleep, or no data.</p>
    </div>

    <div class="chart-card">
      <h2>Top beacons by activity</h2>
      <canvas id="beaconChart"></canvas>
      <p class="small-note">Total IN/LEFT events per beacon in this window.</p>
    </div>

    <div class="chart-card">
      <h2>Events per hour</h2>
      <canvas id="hourlyChart"></canvas>
      <p class="small-note">Shows when notifications are most frequent.</p>
    </div>
  </div>

    <div class="chart-card">
      <h2>Beacon presence (time in range)</h2>
      {% if presence_summary %}
      <canvas id="presenceChart"></canvas>
      <p class="small-note">Pie chart shows in vs out of range for the beacon with the highest in-range percentage. Table below lists all beacons in this window.</p>
      <table>
        <thead>
          <tr>
            <th>Beacon</th>
            <th>In-range %</th>
            <th>Out-of-range %</th>
            <th>In-range hours</th>
            <th>Out-of-range hours</th>
          </tr>
        </thead>
        <tbody>
          {% for p in presence_summary %}
          <tr>
            <td>{{ p.name }}</td>
            <td>{{ p.in_percent }}%</td>
            <td>{{ p.out_percent }}%</td>
            <td>{{ p.in_hours }}</td>
            <td>{{ p.out_hours }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="small-note">No presence data available yet in this window.</p>
      {% endif %}
    </div>

  <div class="card" style="margin-top:18px;">
    <div class="card-title">Status breakdown</div>
    {% if status_breakdown %}
    <table>
      <thead>
        <tr>
          <th>Status</th>
          <th>Count</th>
          <th>Percent</th>
        </tr>
      </thead>
      <tbody>
        {% for row in status_breakdown %}
        <tr>
          <td>
            {% if row.status == 'OK' %}
            <span class="status-ok">OK</span>
            {% elif row.status == 'NO_DEVICES' %}
            <span class="status-nodev">No devices</span>
            {% elif row.status == 'NO_BEACONS' %}
            <span class="status-nobeac">No beacons</span>
            {% elif row.status == 'NO_DATA' %}
            <span class="status-nodata">No data</span>
            {% else %}
            {{ row.status }}
            {% endif %}
          </td>
          <td>{{ row.count }}</td>
          <td>{{ row.percent }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="small-note">No status history recorded yet for this window.</p>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const uptimeLabels = {{ uptime_labels|tojson }};
    const deviceCounts = {{ device_counts|tojson }};
    const beaconCounts = {{ beacon_counts|tojson }};
    const beaconLabels = {{ beacon_labels|tojson }};
    const beaconTotals = {{ beacon_totals|tojson }};
    const beaconIns = {{ beacon_ins|tojson }};
    const beaconLefts = {{ beacon_lefts|tojson }};
    const hourlyLabels = {{ hourly_labels|tojson }};
    const hourlyCounts = {{ hourly_counts|tojson }};
    const presenceSummary = {{ presence_summary|tojson }} || [];
    const presenceLabels = presenceSummary.map(p => p.name);
    const presenceInPercent = presenceSummary.map(p => p.in_percent);
    const presenceOutPercent = presenceSummary.map(p => p.out_percent);


    function createUptimeChart() {
      const ctx = document.getElementById('uptimeChart');
      if (!ctx || uptimeLabels.length === 0) return;
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: uptimeLabels,
          datasets: [
            {
              label: 'Devices',
              data: deviceCounts,
              borderWidth: 2,
              tension: 0.2
            },
            {
              label: 'Beacons',
              data: beaconCounts,
              borderWidth: 2,
              tension: 0.2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { maxRotation: 45, minRotation: 0, autoSkip: true } },
            y: { beginAtZero: true, precision:0 }
          },
          plugins: {
            legend: { labels: { font: { size: 11 } } }
          }
        }
      });
    }

    function createBeaconChart() {
      const ctx = document.getElementById('beaconChart');
      if (!ctx || beaconLabels.length === 0) return;
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: beaconLabels,
          datasets: [
            {
              label: 'Total',
              data: beaconTotals,
              borderWidth: 1
            },
            {
              label: 'IN',
              data: beaconIns,
              borderWidth: 1
            },
            {
              label: 'LEFT',
              data: beaconLefts,
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { autoSkip: false } },
            y: { beginAtZero: true, precision:0 }
          },
          plugins: {
            legend: { labels: { font: { size: 11 } } }
          }
        }
      });
    }

    
    function createPresenceChart() {
      const ctx = document.getElementById('presenceChart');
      if (!ctx || presenceLabels.length === 0) return;

      // Use the first beacon in the presence summary for the pie chart
      const firstIn = presenceInPercent[0] || 0;
      const firstOut = presenceOutPercent[0] || (100 - firstIn);

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['In range', 'Out of range'],
          datasets: [
            {
              data: [firstIn, firstOut],
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }


    function createHourlyChart() {
      const ctx = document.getElementById('hourlyChart');
      if (!ctx || hourlyLabels.length === 0) return;
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: hourlyLabels,
          datasets: [
            {
              label: 'Events',
              data: hourlyCounts,
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, precision:0 }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    window.addEventListener('load', () => {
      createUptimeChart();
      createBeaconChart();
      createPresenceChart();
      createHourlyChart();
    });
  </script>
</body>
</html>