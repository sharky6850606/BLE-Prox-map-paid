<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Beacon Activity Timeline</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <style>
    body { background:#020617; color:#e5e7eb; padding:16px; font-size:14px; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    a { color:#60a5fa; text-decoration:none; }
    a:hover { text-decoration:underline; }
    h1 { font-size:1.4rem; margin-bottom:8px; }
    .back-link { margin-bottom:12px; display:inline-block; }
    .card { background:#020617; border-radius:8px; border:1px solid rgba(55,65,81,0.9); padding:12px 14px; margin-bottom:16px; }
    .card-title { font-size:0.95rem; font-weight:600; margin-bottom:8px; }
    .form-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    label { font-size:0.85rem; }
    select, input[type=date] { background:#020617; border-radius:6px; border:1px solid rgba(75,85,99,1); padding:6px 8px; color:#e5e7eb; font-size:0.85rem; }
    button { background:#3b82f6; border:none; border-radius:6px; padding:6px 10px; font-size:0.85rem; color:white; cursor:pointer; }
    button:hover { background:#2563eb; }
    .timeline-container { position:relative; margin-top:8px; padding-left:18px; }
    .timeline-line { position:absolute; top:0; bottom:0; left:6px; width:2px; background:rgba(55,65,81,0.9); }
    .timeline-item { position:relative; margin-bottom:12px; padding-left:12px; }
    .timeline-dot { position:absolute; left:0; top:6px; width:10px; height:10px; border-radius:999px; background:#64748b; border:2px solid #020617; box-sizing:border-box; }
    .dot-in { background:#22c55e; }
    .dot-left { background:#ef4444; }
    .dot-status { background:#f59e0b; }
    .dot-alert { background:#0ea5e9; }
    .timeline-time { font-size:0.8rem; color:#9ca3af; }
    .timeline-type { font-size:0.9rem; font-weight:600; text-transform:uppercase; }
    .timeline-meta { font-size:0.8rem; color:#cbd5f5; }
    .empty { font-size:0.9rem; color:#9ca3af; margin-top:8px; }
  </style>
</head>
<body>
  <a href="{{ url_for('map.map_page') }}" class="back-link">&larr; Back to map</a>
  <h1>Beacon activity timeline</h1>

    <div class="card">
      <div class="card-title">Select beacon and time range</div>
      <form method="get" class="form-row">
        <label>
          Beacon:
          <select name="beacon">
            <option value="">-- Choose beacon --</option>
            {% for b in beacons %}
            <option value="{{ b.ident }}" {% if selected_beacon == b.ident %}selected{% endif %}>{{ b.label }}</option>
            {% endfor %}
          </select>
        </label>
        Start date:
        <input type="date" name="start_date" value="{{ start_date }}" />
      </label>
      <label>
        End date:
        <input type="date" name="end_date" value="{{ end_date }}" />
      </label>
      <button type="submit">View timeline</button>
    </form>
  </div>

  {% if selected_beacon %}
    <div class="card">
      <div class="card-title">Timeline for {{ selected_beacon }}</div>
      {% if events %}
      <div class="timeline-container">
        <div class="timeline-line"></div>
        {% for e in events %}
        <div class="timeline-item">
          {% set ev_type = e[1] or '' %}
          {% set distance = e[3] %}
          {% set logged = e[4] %}
          <div class="timeline-dot
            {% if ev_type == 'in' %} dot-in
            {% elif ev_type == 'left' %} dot-left
            {% elif ev_type in ['offline','online'] %} dot-status
            {% else %} dot-alert
            {% endif %}"></div>
          <div class="timeline-time">{{ e[2] or '-' }}</div>
          <div class="timeline-type">{{ ev_type.upper() }}</div>
          <div class="timeline-meta">
            {% if distance is not none %}Distance: {{ '%.2f'|format(distance) }} m Â· {% endif %}
            Logged at: {{ logged or '-' }}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="empty">No events found for this beacon in the selected range.</p>
      {% endif %}
    </div>
  {% else %}
    <p class="empty">Choose a beacon above to see its activity timeline.</p>
  {% endif %}
</body>
</html>